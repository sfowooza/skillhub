name: Deploy Skillhub to Google Play

on:
  push:
    branches:
      - main  # or whatever branch you want to trigger the deployment from

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v3
        with:
          java-version: '17.x'
          distribution: 'zulu'
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'  # Specify the Flutter version you need
          channel: 'stable'
      - run: flutter pub get
      - run: flutter build appbundle --release  # This builds an App Bundle, which is recommended for Google Play
      
      # Debug step to inspect Base64 secrets
      - name: Debug Secrets
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" > debug_keystore.txt
          echo "$ANDROID_KEY_PROPERTIES_BASE64" > debug_key_properties.txt
          cat debug_keystore.txt
          cat debug_key_properties.txt
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEY_PROPERTIES_BASE64: ${{ secrets.ANDROID_KEY_PROPERTIES_BASE64 }}
      
      # Steps for signing the app
      - name: Decode Android keystore
        env:
          ANDROID_KEYSTORE: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "$ANDROID_KEYSTORE" | tr -d '\n' | base64 --decode > android/upload-keystore.jks
      
      - name: Check if keystore was decoded correctly
        run: |
          if [ ! -f "android/upload-keystore.jks" ]; then
            echo "Keystore file not found!"
            exit 1
          fi
      
      - name: Decode Android key properties
        env:
          ANDROID_KEY_PROPERTIES: ${{ secrets.ANDROID_KEY_PROPERTIES_BASE64 }}
        run: |
          echo "$ANDROID_KEY_PROPERTIES" | tr -d '\n' | base64 --decode > android/key.properties
      
      - name: Check if key properties was decoded correctly
        run: |
          if [ ! -f "android/key.properties" ]; then
            echo "Key properties file not found!"
            exit 1
          fi
      
      - name: Set up signing environment
        run: |
          echo "STORE_PASSWORD=${{ secrets.STORE_PASSWORD }}" >> $GITHUB_ENV
          echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> $GITHUB_ENV
          echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> $GITHUB_ENV
      
      - name: Deploy to Google Play
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAYSTORE_SERVICE_ACCOUNT }}
          packageName: com.avodah.skillhub.skillhub
          releaseFiles: build/app/outputs/bundle/release/app-release.aab
          track: internal  # or 'alpha', 'beta', 'production'
          status: completed